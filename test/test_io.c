/*
 * @author Bernard Dickens
 */

#include <limits.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>

#include "unity.h"
#include "io.h"

#define BACKSTORE_FILE_PATH "/tmp/test.io.bin"

int writefd;
int readfd;
blfs_backstore_t * backstore;

void setUp(void)
{
    char buf[100];
    snprintf(buf, sizeof buf, "%s%s_%s", "blfs_level", STRINGIZE(BLFS_DEBUG_LEVEL), "test");

    if(dzlog_init(BLFS_CONFIG_ZLOG, buf))
        exit(EXCEPTION_ZLOG_INIT_FAILURE);

    writefd = open(BACKSTORE_FILE_PATH, O_WRONLY | O_CREAT | O_TRUNC, 0666);
    readfd  = open(BACKSTORE_FILE_PATH, O_RDONLY);

    backstore = malloc(sizeof(blfs_backstore_t));
    backstore->read_fd = readfd;
    backstore->write_fd = writefd;
    backstore->body_real_offset = 128;
}

void tearDown(void)
{
    zlog_fini();
    close(backstore->read_fd);
    close(backstore->write_fd);
    unlink(BACKSTORE_FILE_PATH);
    free(backstore);
}

void test_blfs_backstore_read_and_write_works_as_expected(void)
{
    int random_offset = 255;
    uint8_t buffer_actual1[1024];
    uint8_t buffer_actual2[64];
    uint8_t buffer_actual3[64];

    uint8_t * buffer_actual3_ptr = buffer_actual3;
    uint8_t * buffer_expected_zeroes = calloc(sizeof buffer_actual1, sizeof(uint8_t));

    blfs_backstore_write(backstore, buffer_expected_zeroes, sizeof buffer_actual1, 0);
    blfs_backstore_read(backstore, buffer_actual1, sizeof buffer_actual1, 0);

    TEST_ASSERT_EQUAL_MEMORY(buffer_expected_zeroes, buffer_actual1, sizeof buffer_actual1);

    uint8_t buffer_expected_random[sizeof buffer_actual2] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x01, 0x02, 0x03, 0x04
    };

    blfs_backstore_write(backstore, buffer_expected_random, sizeof buffer_actual2, random_offset);
    blfs_backstore_read(backstore, buffer_actual2, sizeof buffer_actual2, random_offset);

    TEST_ASSERT_EQUAL_MEMORY(buffer_expected_random, buffer_actual2, sizeof buffer_actual2);

    blfs_backstore_read(backstore, buffer_actual3_ptr, sizeof(buffer_actual2) / 2, random_offset);
    blfs_backstore_read(backstore,
                        buffer_actual3_ptr + sizeof(buffer_actual2) / 2,
                        sizeof(buffer_actual2) / 2,
                        random_offset + sizeof(buffer_actual2) / 2);

    TEST_ASSERT_EQUAL_MEMORY(buffer_expected_random, buffer_actual3, sizeof buffer_actual3);
}

void test_blfs_backstore_read_body_and_write_body_works_as_expected(void)
{
    uint8_t buffer_actual1[45];
    uint8_t buffer_actual2[256];

    uint8_t buffer_expected_random[sizeof buffer_actual2] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06
    };

    uint8_t buffer_expected_welldefined[sizeof buffer_actual2] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06
    };

    uint8_t buffer_expected_head1[sizeof buffer_actual1] = {
        0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x05, 0x06, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04
    };

    uint8_t buffer_expected_head2[16] = {
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF
    };

    blfs_backstore_write(backstore, buffer_expected_random, sizeof buffer_expected_random, 0);
    blfs_backstore_read_body(backstore, buffer_actual1, sizeof buffer_actual1, 19);

    TEST_ASSERT_EQUAL_MEMORY(buffer_expected_head1, buffer_actual1, sizeof buffer_actual1);

    blfs_backstore_write_body(backstore, buffer_expected_head2, sizeof buffer_expected_head2, 0);
    blfs_backstore_read(backstore, buffer_actual2, sizeof buffer_actual2, 0);
    
    TEST_ASSERT_EQUAL_MEMORY(buffer_expected_welldefined, buffer_actual2, sizeof buffer_actual2);
}

